<!--
Copyright 2018-2025 Felix Garcia Carballeira, Diego Camarmas Alonso,
                    Alejandro Calderon Mateos, Luis Daniel Casais Mezquida

This file is part of CREATOR.

CREATOR is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

CREATOR is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with CREATOR.  If not, see <http://www.gnu.org/licenses/>.
-->

<script lang="ts">
import { defineComponent, type PropType } from "vue"

import type { StackFrame } from "@/core/memory/StackTracker.mjs"
import { architecture } from "@/core/core.mjs"

import UIeltoToolbar from "./general/UIeltoToolbar.vue"
import TableExecution from "./simulator/TableExecution.vue"
import DataViewSelector from "./simulator/DataViewSelector.vue"
import RegisterFile from "./simulator/RegisterFile.vue"
import Examples from "./assembly/Examples.vue"
import Memory from "./simulator/Memory.vue"
import Calculator from "./simulator/Calculator.vue"
import Terminal from "./simulator/Terminal.vue"
import Stats from "./simulator/Stats.vue"
import Flash from "./simulator/Flash.vue"

export default defineComponent({
  props: {
    instructions: { type: Array, required: true },
    browser: { type: String, required: true },
    os: { type: String, required: true },
    dark: { type: Boolean, required: true },
    windowHeight: { type: Number, required: true },
    windowWidth: { type: Number, required: true },
    arch_available: Array,
    architecture_name: { type: String, required: true },
    data_mode: { type: String, required: true },
    reg_representation_int: { type: String, required: true },
    reg_representation_float: { type: String, required: true },
    reg_name_representation: { type: String, required: true },
    stat_representation: { type: String, required: true },
    stat_type: { type: String, required: true },
    memory_segment: { type: String, required: true },
    assembly_code: { type: String, required: true },
    enter: { type: [Boolean, null], required: true },
    display: { type: String, required: true },
    keyboard: { type: String, required: true },
    caller_frame: Object as PropType<StackFrame>,
    callee_frame: Object as PropType<StackFrame>,

    lab_url: { type: String, required: true },
    result_email: { type: String, required: true },
    target_board: { type: String, required: true },
    target_port: { type: String, required: true },
    flash_url: { type: String, required: true },
  },

  components: {
    UIeltoToolbar,
    TableExecution,
    DataViewSelector,
    RegisterFile,
    Examples,
    Memory,
    Calculator,
    Stats,
    Flash,
    Terminal,
  },

  data() {
    return {
      architecture,
    }
  },
})
</script>

<template>
  <b-container fluid align-h="center" id="simulator">
    <b-row>
      <b-col>
        <!-- Navbar -->
        <UIeltoToolbar
          id="navbar_simulator"
          components="btn_architecture,btn_assembly|btn_reset,btn_instruction,btn_run,btn_stop,btn_flash|btn_examples,btn_calculator|btn_configuration,btn_information"
          :browser="browser"
          :os="os"
          :dark="dark"
          :arch_available="arch_available"
          :show_instruction_help="true"
          :instructions="instructions"
          ref="toolbar"
        />

        <!-- Simulator navbar modals -->

        <!-- Flash -->
        <Flash
          id="flash"
          :os="os"
          :assembly_code="assembly_code"
          :lab_url="lab_url"
          :result_email="result_email"
          :target_board="target_board"
          :target_port="target_port"
          :flash_url="flash_url"
        />

        <!-- Examples modal -->
        <Examples
          id="examples-simulator"
          :architecture_name="architecture_name"
          :compile="true"
        />

        <!-- Calculator -->
        <Calculator id="calculator" />

        <b-row align-h="center">
          <!-- Column 1: Execution instruction -->
          <b-col lg="7">
            <TableExecution
              :instructions="instructions"
              :enter="enter"
              ref="tableExecution"
            />
          </b-col>

          <!-- Column 2: Execution data (split into top: data, bottom: terminal) -->
          <b-col lg="5" class="execution-data-col">
            <!-- Top row: current execution data (70%) -->
            <b-row class="mb-2 execution-data-top">
              <b-col>
                <!-- View selector -->
                <DataViewSelector
                  :data_mode="data_mode"
                  :register_file_num="architecture.components.length"
                  :dark="dark"
                />

                <!-- Registers view -->
                <RegisterFile
                  v-if="data_mode == 'int_registers' || data_mode == 'fp_registers'"
                  :data_mode="data_mode"
                  :reg_representation_int="reg_representation_int"
                  :reg_representation_float="reg_representation_float"
                  :reg_name_representation="reg_name_representation"
                  :dark="dark"
                  ref="registerFile"
                />

                <!-- Memory view-->
                <Memory
                  v-if="data_mode === 'memory'"
                  ref="memory"
                  :selectedSegment="memory_segment"
                  :dark="dark"
                  :callee_frame="callee_frame"
                  :caller_frame="caller_frame"
                />

                <!-- Stats view--->
                <Stats
                  v-if="data_mode === 'stats'"
                  ref="stats"
                  :dark="dark"
                  :representation="stat_representation"
                  :type="stat_type"
                />
              </b-col>
            </b-row>

            <!-- Bottom row: terminal (30%) -->
            <b-row class="execution-data-bottom">
              <b-col class="terminal-col">
                <Terminal
                  :display="display"
                  :keyboard="keyboard"
                  :enter="enter"
                  ref="terminal"
                />
              </b-col>
            </b-row>
          </b-col>


        </b-row>
      </b-col>
    </b-row>
  </b-container>
</template>

<style lang="scss" scoped>
.terminal-col {
  display: flex;
  flex-direction: column;
  /* Terminal fills the bottom area */
  flex: 3 1 0%;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.execution-data-col {
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.execution-data-top {
  flex: 8 1 0%;
  min-height: 0;
  overflow: auto; /* scroll if content is larger than area */
}

.execution-data-bottom {
  flex: 2 1 0%;
  min-height: 0;
}

:deep() {
  .consoleIcon {
    opacity: 0.6;
  }

  .groupLabelling {
    float: top;
    position: relative;
    top: -0.6vw;
  }
}

:deep(.registerPopover) {
  background-color: #ceecf5;
  font-family: monospace;
  font-weight: normal;
  font-size: 0.7em;
}
</style>
